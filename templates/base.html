<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠ - {% block title %}{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="{{url_for('static',filename='tailwindcss.js')}}"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS for RTL -->
    <style>
        :root {
            --sidebar-width: 16rem;
            --sidebar-collapsed-width: 5rem;
            --header-height: 4rem;
        }
        
        .rtl {
            direction: rtl;
            text-align: right;
        }
        
        /* Sidebar animations */
        .sidebar {
            transition: all 0.3s ease-in-out;
        }
        
        .sidebar-collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar-expanded {
            width: var(--sidebar-width);
        }
        
        /* Mobile menu */
        @media (max-width: 768px) {
            .sidebar-mobile {
                position: fixed;
                top: 0;
                right: 0;
                height: 100vh;
                z-index: 40;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
            }
            
            .sidebar-mobile-open {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                right: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            
            .sidebar-overlay-open {
                display: block;
            }
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Loading spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Card hover effects */
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Badge animations */
        .badge-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        /* Alert colors */
        .alert-critical {
            border-right: 4px solid #dc2626;
            background: linear-gradient(to left, #fef2f2, #fff);
        }
        
        .alert-warning {
            border-right: 4px solid #d97706;
            background: linear-gradient(to left, #fffbeb, #fff);
        }
        
        .alert-info {
            border-right: 4px solid #2563eb;
            background: linear-gradient(to left, #eff6ff, #fff);
        }
        
        /* Table responsive */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 rtl">
    {% if current_user.is_authenticated %}
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white shadow-lg fixed top-0 right-0 left-0 z-30" style="height: var(--header-height);">
        <div class="flex items-center justify-between h-full px-4">
            <!-- Left side: Logo and menu button -->
            <div class="flex items-center space-x-4 space-x-reverse">
                <!-- Mobile menu button -->
                <button id="mobile-menu-button" class="md:hidden p-2 hover:bg-blue-700 rounded-lg">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <!-- Desktop sidebar toggle -->
                <button id="desktop-sidebar-toggle" class="hidden md:block p-2 hover:bg-blue-700 rounded-lg">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <!-- Logo -->
                <div class="flex items-center space-x-3 space-x-reverse">
                    <div class="bg-blue-500 p-2 rounded-lg">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø°ÙƒÙŠ</h1>
                        <p class="text-xs text-blue-200 opacity-80">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ†Ø¨Ø¤ Ø§Ù„Ù„Ø­Ø¸ÙŠ</p>
                    </div>
                </div>
            </div>
            
            <!-- Right side: User info and notifications -->
            <div class="flex items-center space-x-4 space-x-reverse">
                <!-- Notifications -->
                <div class="relative">
                    <button id="notification-button" class="p-2 hover:bg-blue-700 rounded-lg relative">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notification-badge" class="absolute -top-1 -left-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden"></span>
                    </button>
                    
                    <!-- Notifications dropdown -->
                    <div id="notification-dropdown" class="hidden absolute left-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-40 border border-gray-200">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
                        </div>
                        <div id="notification-list" class="max-h-96 overflow-y-auto custom-scrollbar">
                            <!-- Notifications will be loaded here -->
                        </div>
                        <div class="p-3 border-t text-center">
                            <a href="#" class="text-blue-600 hover:text-blue-800 text-sm">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</a>
                        </div>
                    </div>
                </div>
                
                <!-- User profile -->
                <div class="relative">
                    <button id="user-menu-button" class="flex items-center space-x-2 space-x-reverse p-2 hover:bg-blue-700 rounded-lg">
                        <div class="w-8 h-8 bg-blue-400 rounded-full flex items-center justify-center">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="hidden md:block text-right">
                            <p class="font-medium text-sm">{{ current_user.username }}</p>
                            <p class="text-xs text-blue-200 opacity-80">
                                {% if current_user.role == 'admin' %}Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…
                                {% elif current_user.role == 'manager' %}Ù…Ø¯ÙŠØ± ÙØ±Ø¹
                                {% elif current_user.role == 'auditor' %}Ù…Ø±Ø§Ø¬Ø¹
                                {% else %}{{ current_user.role }}{% endif %}
                            </p>
                        </div>
                        <i class="fas fa-chevron-down text-sm hidden md:block"></i>
                    </button>
                    
                    <!-- User dropdown -->
                    <div id="user-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-40 border border-gray-200">
                        <div class="p-3 border-b">
                            <p class="font-bold text-gray-800">{{ current_user.username }}</p>
                            <p class="text-sm text-gray-600">{{ current_user.email }}</p>
                        </div>
                        <div class="py-2">
                            <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-user-cog ml-3"></i>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                            </a>
                            <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog ml-3"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                            </a>
                            <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-question-circle ml-3"></i>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
                            </a>
                        </div>
                        <div class="py-2 border-t">
                            <a href="{{ url_for('logout') }}" class="block px-4 py-2 text-red-600 hover:bg-red-50">
                                <i class="fas fa-sign-out-alt ml-3"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Mobile overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gray-800 text-white fixed top-[60px] right-0 h-full z-40 sidebar-expanded 
                                sidebar-mobile md:sidebar-expanded">
        <!-- Close button for mobile -->
        <div class="md:hidden p-4 border-b border-gray-700 flex justify-between items-center">
            <h2 class="text-lg font-bold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
            <button id="close-mobile-sidebar" class="p-2 hover:bg-gray-700 rounded-lg">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Sidebar content -->
        <div class="p-4 h-full flex flex-col">
            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Main Menu -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-400 mb-3 px-3 uppercase tracking-wider">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                    <ul class="space-y-1">
                        <li>
                            <a href="{{ url_for('dashboard') }}" 
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'dashboard' %}bg-gray-700 bg-opacity-50 border-r-4 border-blue-500{% endif %}">
                                <i class="fas fa-tachometer-alt ml-3 text-lg"></i>
                                <span class="sidebar-text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                            </a>
                        </li>
                        
                        {% if current_user.role in ['admin', 'manager'] %}
                        <li>
                            <a href="#" onclick="showTransferModal()"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-exchange-alt ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</span>
                            </a>
                        </li>
                        
                        <li>
                            <a href="#" onclick="showReports()"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-chart-line ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if current_user.role == 'admin' %}
                        <li>
                            <a href="{{ url_for('admin_users') }}"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-users-cog ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                            </a>
                        </li>
                        
                        <li>
                            <a href="{{ url_for('branches_management') }}"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-code-branch ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹</span>
                            </a>
                        </li>
                        {% endif %}
                        


                        {% if current_user.role in ['admin', 'manager'] %}
<li>
    <a href="{{ url_for('liquidity_management') }}" 
       class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'liquidity_management' %}bg-gray-700 bg-opacity-50 border-r-4 border-blue-500{% endif %}">
        <i class="fas fa-money-bill-wave ml-3 text-lg"></i>
        <span class="sidebar-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø©</span>
    </a>
</li>
{% endif %}
<!--
                        <li>
                            <a href="#" onclick="showReports()"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-chart-bar ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                            </a>
                        </li>
                        
                        <li>
                            <a href="#" onclick="showAlerts()"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-bell ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
                                <span id="sidebar-alert-count" class="bg-red-500 text-white text-xs rounded-full px-2 py-1 mr-auto hidden"></span>
                            </a>
                        </li>
                    -->






<!--
{% if current_user.role in ['admin', 'risk_manager', 'branch_manager', 'auditor'] %}
<li class="mt-6">
    <h3 class="text-sm font-semibold text-gray-400 mb-3 px-3 uppercase tracking-wider">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
    <ul class="space-y-1">
        <li>
            <a href="{{ url_for('risk_dashboard') }}" 
               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'risk_dashboard' %}bg-gray-700 bg-opacity-50 border-r-4 border-red-500{% endif %}">
                <i class="fas fa-shield-alt ml-3 text-lg text-red-400"></i>
                <span class="sidebar-text">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </a>
        </li>
        
        <li>
            <a href="{{ url_for('risk_register') }}" 
               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'risk_register' %}bg-gray-700 bg-opacity-50 border-r-4 border-red-500{% endif %}">
                <i class="fas fa-clipboard-list ml-3 text-lg text-orange-400"></i>
                <span class="sidebar-text">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </a>
        </li>
        
        <li>
            <a href="{{ url_for('risk_incidents') }}" 
               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'risk_incidents' %}bg-gray-700 bg-opacity-50 border-r-4 border-red-500{% endif %}">
                <i class="fas fa-exclamation-circle ml-3 text-lg text-yellow-400"></i>
                <span class="sidebar-text">Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </a>
        </li>
        
        <li>
            <a href="{{ url_for('kri_monitoring') }}" 
               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'kri_monitoring' %}bg-gray-700 bg-opacity-50 border-r-4 border-red-500{% endif %}">
                <i class="fas fa-chart-line ml-3 text-lg text-green-400"></i>
                <span class="sidebar-text">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </a>
        </li>
        
        <li>
            <a href="{{ url_for('risk_reports') }}" 
               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors {% if request.endpoint == 'risk_reports' %}bg-gray-700 bg-opacity-50 border-r-4 border-red-500{% endif %}">
                <i class="fas fa-file-contract ml-3 text-lg text-blue-400"></i>
                <span class="sidebar-text">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </a>
        </li>
    </ul>
</li>
{% endif %}
-->


                    </ul>
                </div>
                
                <!-- System Menu -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-400 mb-3 px-3 uppercase tracking-wider">Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                    <ul class="space-y-1">
                        <li>
                            <a href="{{ url_for('system_settings') }}"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-cog ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                            </a>
                        </li>
                        <!--
                        <li>
                            <a href="#"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-shield-alt ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„Ø£Ù…Ø§Ù†</span>
                            </a>
                        </li>
                        
                        <li>
                            <a href="#"
                               class="flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-question-circle ml-3 text-lg"></i>
                                <span class="sidebar-text">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</span>
                            </a>
                        </li>
                        --}}
                    </ul>
                </div>
                
                <!-- Basel III Compliance -->
                <div class="mt-auto p-4 bg-gray-700 rounded-lg">
                    <div class="flex items-center mb-2">
                        <div class="bg-green-500 p-2 rounded-lg ml-3">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <div>
                            <p class="font-semibold">Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹</p>
                            <p class="text-xs text-gray-300">Ù…Ø¹Ø§ÙŠÙŠØ± Basel III</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-300">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆØ§ÙÙ‚:</span>
                            <span class="text-green-400 font-semibold">100%</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2 mt-1">
                            <div clas="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main id="main-content" class="pt-16 pr-0 md:pr-64 transition-all duration-300 ease-in-out min-h-screen">
        <div class="p-4 md:p-6">
            {% block content %}{% endblock %}
        </div>
    </main>
    
    <!-- Bottom Navigation for Mobile -->
    <nav class="md:hidden fixed bottom-0 right-0 left-0 bg-white border-t border-gray-200 z-30">
        <div class="flex justify-around items-center h-16">
            <a href="{{ url_for('dashboard') }}" 
               class="flex flex-col items-center justify-center p-2 text-blue-600">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            
            {% if current_user.role in ['admin', 'manager'] %}
            <a href="#" onclick="showTransferModal()"
               class="flex flex-col items-center justify-center p-2 text-gray-600 hover:text-blue-600">
                <i class="fas fa-exchange-alt text-xl"></i>
                <span class="text-xs mt-1">ØªØ­ÙˆÙŠÙ„</span>
            </a>
            {% endif %}
            
            <a href="#" onclick="showAlerts()"
               class="flex flex-col items-center justify-center p-2 text-gray-600 hover:text-blue-600 relative">
                <i class="fas fa-bell text-xl"></i>
                <span class="text-xs mt-1">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
                <span id="mobile-alert-badge" class="absolute -top-1 -left-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden"></span>
            </a>
            
            <a href="#" onclick="toggleUserMenu()"
               class="flex flex-col items-center justify-center p-2 text-gray-600 hover:text-blue-600">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Ø­Ø³Ø§Ø¨ÙŠ</span>
            </a>
        </div>
    </nav>
    {% else %}
        {% block auth_content %}{% endblock %}
    {% endif %}
    
    <!-- SocketIO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // Initialize SocketIO connection
        let socket;
        
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to WebSocket server');
                // Request initial data
                socket.emit('request_initial_data', {user_id: '{{ current_user.id if current_user.is_authenticated else "" }}'});
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from WebSocket server');
            });
            
            socket.on('liquidity_update', function(data) {
                console.log('Liquidity update:', data);
                updateBranchLiquidity(data);
            });
            
            socket.on('new_alert', function(data) {
                console.log('New alert:', data);
                showAlertNotification(data);
                updateAlertCounts(1);
            });
            
            socket.on('transfer_completed', function(data) {
                console.log('Transfer completed:', data);
                showTransferNotification(data);
            });
        }
        
        // Initialize socket if user is authenticated
        {% if current_user.is_authenticated %}
        document.addEventListener('DOMContentLoaded', initSocket);
        {% endif %}
        
        // Sidebar functionality
        let sidebarCollapsed = false;
        
        // Toggle sidebar on desktop
        document.getElementById('desktop-sidebar-toggle')?.addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            if (sidebarCollapsed) {
                // Expand sidebar
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                mainContent.classList.remove('md:pr-16');
                mainContent.classList.add('md:pr-64');
                
                // Show sidebar text
                document.querySelectorAll('.sidebar-text').forEach(el => {
                    el.classList.remove('hidden');
                });
            } else {
                // Collapse sidebar
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.remove('md:pr-64');
                mainContent.classList.add('md:pr-16');
                
                // Hide sidebar text
                document.querySelectorAll('.sidebar-text').forEach(el => {
                    el.classList.add('hidden');
                });
            }
            
            sidebarCollapsed = !sidebarCollapsed;
            localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        });
        
        // Mobile sidebar functionality
        document.getElementById('mobile-menu-button')?.addEventListener('click', function() {
            openMobileSidebar();
        });
        
        document.getElementById('close-mobile-sidebar')?.addEventListener('click', function() {
            closeMobileSidebar();
        });
        
        document.getElementById('sidebar-overlay')?.addEventListener('click', function() {
            closeMobileSidebar();
        });
        
        function openMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.add('sidebar-mobile-open');
            overlay.classList.add('sidebar-overlay-open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.remove('sidebar-mobile-open');
            overlay.classList.remove('sidebar-overlay-open');
            document.body.style.overflow = 'auto';
        }
        
        // Toggle notification dropdown
        document.getElementById('notification-button')?.addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Hide other dropdowns
            document.getElementById('user-dropdown')?.classList.add('hidden');
        });
        
        // Toggle user dropdown
        document.getElementById('user-menu-button')?.addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Hide other dropdowns
            document.getElementById('notification-dropdown')?.classList.add('hidden');
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function() {
            document.getElementById('notification-dropdown')?.classList.add('hidden');
            document.getElementById('user-dropdown')?.classList.add('hidden');
        });
        
        // Load sidebar state from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                // Trigger click on desktop sidebar toggle to collapse
                document.getElementById('desktop-sidebar-toggle')?.click();
            }
            
            // Update alert counts
            updateAlertCounts(0);
        });
        
        // Helper functions
        function updateBranchLiquidity(data) {
            const branchElement = document.querySelector(`[data-branch-id="${data.branch_id}"]`);
            if (branchElement) {
                const liquidityElement = branchElement.querySelector('.current-liquidity');
                if (liquidityElement) {
                    const formatted = new Intl.NumberFormat('ar-SA').format(data.liquidity.toFixed(2));
                    liquidityElement.textContent = formatted + ' Ø±.ÙŠ';
                    
                    const minLiquidity = parseFloat(branchElement.dataset.minLiquidity || 0);
                    if (data.liquidity < minLiquidity) {
                        liquidityElement.className = 'current-liquidity font-bold text-lg text-red-600';
                    } else if (data.liquidity < minLiquidity * 1.2) {
                        liquidityElement.className = 'current-liquidity font-bold text-lg text-yellow-600';
                    } else {
                        liquidityElement.className = 'current-liquidity font-bold text-lg text-green-600';
                    }
                }
            }
        }
        
        function showAlertNotification(alertData) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-20 left-4 z-50 p-4 rounded-lg shadow-xl max-w-md ${
                alertData.alerts?.[0]?.severity === 'high' 
                ? 'bg-red-50 border-r-4 border-red-500' 
                : 'bg-yellow-50 border-r-4 border-yellow-500'
            } animate__animated animate__slideInLeft`;
            
            toast.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle mt-1 ml-3 ${
                        alertData.alerts?.[0]?.severity === 'high' 
                        ? 'text-red-600' 
                        : 'text-yellow-600'
                    }"></i>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${
                            alertData.alerts?.[0]?.severity === 'high' 
                            ? 'ğŸš¨ ØªØ­Ø°ÙŠØ± Ø¹Ø§Ø¬Ù„' 
                            : 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡'
                        }</h4>
                        <p class="text-gray-700 mt-1">${alertData.alerts?.[0]?.message || 'ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯'}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-sm text-gray-500">${new Date().toLocaleTimeString('ar-SA')}</span>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 8000);
            
            // Add to notification list
            addToNotificationList(alertData);
        }
        
        function addToNotificationList(alertData) {
            const list = document.getElementById('notification-list');
            if (!list) return;
            
            const notification = document.createElement('div');
            notification.className = `p-3 border-b hover:bg-gray-50 cursor-pointer ${
                alertData.alerts?.[0]?.severity === 'high' 
                ? 'border-r-4 border-red-500' 
                : 'border-r-4 border-yellow-500'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="ml-3">
                        <i class="fas fa-exclamation-triangle ${
                            alertData.alerts?.[0]?.severity === 'high' 
                            ? 'text-red-500' 
                            : 'text-yellow-500'
                        }"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${alertData.alerts?.[0]?.message || 'ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯'}</p>
                        <p class="text-sm text-gray-600 mt-1">${new Date().toLocaleTimeString('ar-SA')}</p>
                    </div>
                </div>
            `;
            
            list.insertBefore(notification, list.firstChild);
        }
        
        function updateAlertCounts(increment = 0) {
            const badges = [
                'notification-badge',
                'sidebar-alert-count',
                'mobile-alert-badge'
            ];
            
            badges.forEach(badgeId => {
                const badge = document.getElementById(badgeId);
                if (badge) {
                    let currentCount = parseInt(badge.textContent) || 0;
                    currentCount += increment;
                    if (currentCount > 0) {
                        badge.textContent = currentCount;
                        badge.classList.remove('hidden');
                        badge.classList.add('badge-pulse');
                    } else {
                        badge.classList.add('hidden');
                        badge.classList.remove('badge-pulse');
                    }
                }
            });
        }
        
        function showTransferNotification(data) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-4 z-50 p-4 rounded-lg shadow-xl max-w-md bg-green-50 border-r-4 border-green-500 animate__animated animate__slideInLeft';
            
            toast.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-check-circle mt-1 ml-3 text-green-600"></i>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">âœ… ØªØ­ÙˆÙŠÙ„ Ù†Ø§Ø¬Ø­</h4>
                        <p class="text-gray-700 mt-1">ØªÙ… ØªØ­ÙˆÙŠÙ„ ${data.amount?.toLocaleString('ar-SA') || '0'} Ø±.ÙŠ Ø¨Ù†Ø¬Ø§Ø­</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-sm text-gray-500">${new Date().toLocaleTimeString('ar-SA')}</span>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Global functions
        window.showTransferModal = function(branchId = null) {
            closeMobileSidebar(); // Close sidebar on mobile when opening modal
            
            // Create and show modal (will be implemented in child templates)
            alert('Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§');
        };
        
        window.showReports = function() {
            closeMobileSidebar();
            alert('ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        };
        
        window.showAlerts = function() {
            closeMobileSidebar();
            alert('ØµÙØ­Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        };
        
        window.toggleUserMenu = function() {
            // Show user menu on mobile
            alert('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        };
        
        // Format currency helper
        window.formatCurrency = function(amount) {
            return new Intl.NumberFormat('ar-SA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + ' Ø±.ÙŠ';
        };
    </script>
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    {% block extra_js %}{% endblock %}
</body>
</html>